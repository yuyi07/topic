<html><head>
<link rel="stylesheet" type="text/css" href="carStyle.css">
</head>

<body style='overflow:hidden'> 
<div id="info">auto parking -> stop parking -> manual<br>
	<h2 id="warning">no hit</h2>
	<button id="parking"> auto parking </button>
	<button id="parkingModeButton"> Mode 1</button>
	<button id='soundBT'>Radar Sound Off</button>
</div>

<audio id="radarSound" style="display:none" muted>
<source src="https://huitney.github.io/topic/sounds/radar.wav" type='audio/wav'>
</audio>

<script src="https://threejs.org/build/three.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://jyunming-chen.github.io/tutsplus/js/KeyboardState.js"></script>
<script src="https://raw.githack.com/mrdoob/three.js/dev/examples/js/loaders/MTLLoader.js"></script>
<script src="https://raw.githack.com/mrdoob/three.js/dev/examples/js/loaders/OBJLoader.js"></script>
<script src="buildThings.js"></script>
<script src="func.js"></script>
<script src="buildScenes.js"></script>

<button id="topView"><img src ="https://i.imgur.com/96tj0yh.png?2" style="width:80px;height:80px;"></button>
<button id="thirdPV"><img src="https://i.imgur.com/OvvIh4R.png?2" style="width:80px;height:80px;"></button>
<button id="firstPV"><img src="https://i.imgur.com/AX5vRqY.png" style="width:80px;height:80px;"></button>

<button id="CCW"><img src="https://i.imgur.com/rNCP4q9.png" style="width:40px;height:45px;"></button>
<button id="zoomIn"><img src="https://i.imgur.com/Or603WK.png" style="width:40px;height:45px;"></button>
<button id="zoomOut"><img src="https://i.imgur.com/PIEYHkm.png" style="width:40px;height:45px;"></button>

<script>

( function() {
	Math.clamp = function(val,min,max) {
		return Math.min(Math.max(val,min),max);
	} 
})();

var scene, renderer, camera;
var keyboard = new KeyboardState();
var clock = new THREE.Clock();

var car, obstacles = [];
var radarSound;

var sceneHUD, topCamera, cameraHUD;
var topViewTurn = false, soundBT = false;
var thirdPV = false, firstPV = false;
var parkingMode = 0, parkingLocate = [];
var PPart = 0;
var parkingModeButton = false, rearMirror;
var traceMeshes = [];
var traficLights = [];



//button
$("#topView").click(function() {
	topViewTurn = !topViewTurn;
	if(topViewTurn){
		CCW.style.visibility='visible';
		zoomIn.style.visibility='visible';
		zoomOut.style.visibility='visible';
	}else{
		CCW.style.visibility='hidden';
		zoomIn.style.visibility='hidden';
		zoomOut.style.visibility='hidden';
	}
});

$("#CCW").click(function() {
	topCamera.rotation.y += Math.PI/2;
	let cameraAngle = topCamera.clone().rotation.y % (Math.PI*2);
	if(cameraAngle == Math.PI/2){
		topCamera.up.set(-1, 0, 0);
		topCamera.lookAt(0, 0, 0);
		topCamera.rotation.y = Math.PI/2;
	}
	else if(cameraAngle == Math.PI){
		topCamera.up.set(0, 0, 1);
		topCamera.lookAt(0, 0, 0);
		topCamera.rotation.y = Math.PI;
	}
	else if(cameraAngle == Math.PI*3/2){
		topCamera.up.set(1, 0, 0);
		topCamera.lookAt(0, 0, 0);
		topCamera.rotation.y = Math.PI*3/2;
	}
	else if(cameraAngle == 0){
		topCamera.up.set(0, 0, -1);
		topCamera.lookAt(0, 0, 0);
		topCamera.rotation.y = 0;
	}
});

$("#zoomIn").click(function() {
	topCamera.position.y -= 10;
});

$("#zoomOut").click(function() {
	topCamera.position.y += 10;
});

$("#thirdPV").click(function() {
	thirdPV = !thirdPV;
	if(thirdPV)
		firstPV = false;
});

$("#firstPV").click(function() {
	firstPV = !firstPV;
	if(firstPV)
		thirdPV = false;
});

$("#parking").click(function() {
	parkingMode++;
	if(parkingMode > 2) parkingMode = 0;
	
	if(parkingMode == 0){
		$("#parking").text('auto parking');
	}
	else if(parkingMode == 1){
		$("#parking").text('stop parking');
		parkingLocate.push(car.angle, car.center);
	}
	else{
		$("#parking").text('manual');
	}
});

$("#soundBT").click(function() {
	soundBT =! soundBT;
	if(soundBT){
		radarSound.volume = 0;
		$("#soundBT").text('Radar Sound On');
	}
	else{
		radarSound.volume = 1;
		$("#soundBT").text('Radar Sound Off');
	}
});

$("#parkingModeButton").click(function() {
	parkingModeButton = !parkingModeButton;
	if(parkingModeButton){
		$("#parkingModeButton").text('Mode 2');
		//car.mesh.position.z = 30;
	}

	else{
		$("#parkingModeButton").text('Mode 1');
		//car.mesh.position.z = 40;
	}
		
});

init();
animate();
  
function init() {

	scene = new THREE.Scene();
	renderer = new THREE.WebGLRenderer();
	renderer.setSize(window.innerWidth, window.innerHeight);
	renderer.setClearColor(0x888888);
	document.body.appendChild(renderer.domElement);

	camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
	camera.position.set(-200, 100, 0);
	let controls = new THREE.OrbitControls(camera, renderer.domElement);

	var light = new THREE.HemisphereLight(0xffffff, 0x000000, 1);
	light.position.set(0, 100, 0);
	scene.add(light);
	
	buildScenes();
	
	/*
	var grid = new THREE.GridHelper (900,90,'red','white');
	scene.add (grid);
	/*const axesHelper = new THREE.AxesHelper( 25 );
	scene.add( axesHelper );
	*/

    ////////////////////////////////////////////////////////////
	//car
    car = buildCar(new THREE.Vector3(-72.5, 13, 23));
	
	//obstacles
	//var car2 = buildCar(new THREE.Vector3(55, 13, 70));
	//var car3 = buildCar(new THREE.Vector3(-55, 13, 70));
	
    //obstacles.push(car2, car3);
	
	//light
	var light = new THREE.AmbientLight( 0x404040 ); // soft white light
	scene.add( light );
  
    window.addEventListener('resize', onWindowResize, false);
  
    ////////////////////////////
    RCmesh = new THREE.Mesh (new THREE.SphereGeometry(5,6,6), new THREE.MeshBasicMaterial());
    scene.add(RCmesh);

    //////////////////////////////////////////////
    renderer.autoClear = false;
	
    //topCamera
    sceneHUD = new THREE.Scene();
    topCamera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
    topCamera.position.y = 200;
	topCamera.up.set(0, 0, -1);
	topCamera.lookAt(0, 0, 0);
	CCW.style.visibility='hidden';
	zoomIn.style.visibility='hidden';
	zoomOut.style.visibility='hidden';
	
	//rear mirror
	sceneHUD1 = new THREE.Scene();
    rearMirror = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
    rearMirror.position.set(-60, 23, 40);
	
	
	//Reversing camera
	sceneHUD2= new THREE.Scene();
    reversingCamera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
	reversingCamera.position.set(-60, 23, 40);
	
	//360 surround view lens
	sceneHUD3= new THREE.Scene();
    surroundCamera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
	surroundCamera.position.set(-60, 23, 40);
	
	
	//sound
	radarSound = document.getElementById('radarSound');
	radarSound.muted = false;

	
	drawFrame();
	drawReversingLine();
}
  
function onWindowResize() {
	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(window.innerWidth, window.innerHeight);
}
  
function animate() {
	
    renderer.clear(true);
	//topControls.update();

    
    keyboard.update();
  
    // 'static' variables  
	this.theta = (this.theta === undefined) ? 0.001 : this.theta;
    this.fSlowDown = (this.fSlowDown === undefined) ? 0 : this.fSlowDown;
    this.bSlowDown = (this.bSlowDown === undefined) ? 0 : this.bSlowDown;
  
    /////////////////////////////////////////////////////////////////
    //move car	
	
	if (keyboard.pressed('down')){
		car.speed -= 1;
	}
	if (keyboard.pressed('up')){
		car.speed += 1;
	}
	car.speed = Math.clamp (car.speed, -50, 70);
  
    if (keyboard.pressed('right'))
		this.theta -= 0.02;
    if (keyboard.pressed('left'))
		this.theta += 0.02;  
    this.theta = Math.clamp (this.theta, -Math.PI/7, Math.PI/7);
	
	car.leftfrontWheel.rotation.y = Math.atan(26/(26/Math.tan(this.theta)-8));
    car.rightfrontWheel.rotation.y = Math.atan(26/(26/Math.tan(this.theta)+8));

    //////////////////////////////////////////////////////////////
    
    RC = car.mesh.localToWorld (new THREE.Vector3(-13,0,-26/Math.tan(this.theta)));
    RCmesh.position.copy (RC);
    
    var omega = car.speed * Math.tan(this.theta)/24;
    var deltaT = clock.getDelta();
    
    moveCar(RC, omega, deltaT);
	
    //////////////////////////////////////////////////////////////
    // slowing down    after keyboard up
    if (keyboard.up("up")) 
		this.fSlowDown = 1; 
    else if (keyboard.up("down"))	
		this.bSlowDown = 1;
       
    if (keyboard.down("up") ||  keyboard.down("down"))
		this.fSlowDown = this.bSlowDown = 0;
      
    if (this.fSlowDown == 1) {
		if(car.speed >= 0) {  // moving forward --> slow down gradually
			car.speed -= 1;
		} else if (car.speed <= 0) {  // moving backward --> stop immediately
			car.speed = 0;
			this.fSlowDown = 0;
		}
    } else if (this.bSlowDown == 1) {
		if(car.speed <= 0) {
			car.speed += 1;
		} else if (car.speed >= 0) {
			car.speed = 0;
			this.bSlowDown = 0;
		}
    }
	
    //camera position
	cameraUpdate(this.theta, this.fSlowDown, this.bSlowDown);
	
    //parking 
	this.theta = parking(this.theta);

	//Shift
	shiftGearLever();



	//Reversing display line
	var trace = new THREE.Vector3 (-25,0,0);
	car.mesh.localToWorld (trace);
	traceMeshes[0].position.copy (trace);

	rotateTrace (RC, this.theta);
		  
    /////////////////////////////////////////////
    // purely cosmetic ...    wheel turn  
    car.leftfrontWheel.rotation.z += car.speed*deltaT/5;
    car.rightfrontWheel.rotation.z += car.speed*deltaT/5;
    car.leftRearWheel.rotation.z += car.speed*deltaT/5;
    car.rightRearWheel.rotation.z += car.speed*deltaT/5;
  
    requestAnimationFrame(animate);
    render();
}
  
function render() {
	var WW = window.innerWidth;
	var HH = window.innerHeight;
    renderer.setScissorTest( true );

    renderer.setViewport(0, 0, WW, HH);
    renderer.setScissor(0, 0, WW, HH);
    renderer.clear();
    renderer.render(scene, camera);

    if (topViewTurn) {
		renderer.render(sceneHUD, topCamera);
		renderer.setViewport(WW/1.35, HH/1.5, WW/5, HH/3.5);
		renderer.setScissor(WW/1.35, HH/1.5, WW/5, HH/3.5);
		renderer.clear();
		renderer.render(scene, topCamera);
    }
	if(firstPV){
		renderer.render(sceneHUD1, rearMirror);
		renderer.setViewport(WW/1.43, HH/1.44, WW/3.5, HH/7.3);
		renderer.setScissor(WW/1.43, HH/1.44, WW/3.5, HH/7.3);
		renderer.clear();
		renderer.render(scene, rearMirror);
		

		//reversing Camera
		if(car.speed < 0){
			renderer.render(sceneHUD2, reversingCamera);
			//renderer.setViewport(WW/1.43, HH/1.44, WW/3.5, HH/7.3);
			//renderer.setScissor(WW/1.43, HH/1.44, WW/3.5, HH/7.3);
			renderer.setViewport(WW/1.43, HH/1.44, WW/6.8, HH/7.4);
			renderer.setScissor(WW/1.43, HH/1.44, WW/6.8, HH/7.4);
			renderer.clear();
			renderer.render(scene, reversingCamera);
			
			renderer.render(sceneHUD3, surroundCamera);
			//renderer.setViewport(WW/1.43, HH/1.44, WW/3.5, HH/7.3);
			//renderer.setScissor(WW/1.43, HH/1.44, WW/3.5, HH/7.3);
			renderer.setViewport(WW/1.185, HH/1.44, WW/7, HH/7.4);
			renderer.setScissor(WW/1.185, HH/1.44, WW/7, HH/7.4);
			renderer.clear();
			renderer.render(scene, surroundCamera);
		}
	}

	renderer.setScissorTest( false );
}
</script></body></html>